<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper
  PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
  "https://mybatis.org/dtd/mybatis-3-mapper.dtd">
 
  <mapper namespace="com.semi.main.admin.AdminDAO">
  <sql id="searchSql">
  	WHERE M.USERNO>0
  		<if test="kind == 'userId'">
  		AND M.USERID LIKE '%'||#{search}||'%'
  		</if>
  		<if test="kind == 'email'">
  		AND M.EMAIL LIKE '%'||#{search}||'%'
  		</if>
  		<if test="kind == 'phone'">
  		AND M.PHONE LIKE '%'||#{search}||'%'
  		</if>	
  </sql>
  <sql id="searchSql2">
  	WHERE A.REPORTNO>0
  		<if test="kind == 'userId'">
  		AND A.USERID LIKE '%'||#{search}||'%'
  		</if>
  		<if test="kind == 'catName'">
  		AND A.CATNAME LIKE '%'||#{search}||'%'
  		</if>
  		<if test="kind == 'title'">
  		AND A.TITLE LIKE '%'||#{search}||'%'
  		</if>	
  </sql>
  	
  	<delete id="c"></delete>
  	
  	<select id="memberList" parameterType="Pager" resultMap="getResult">
		SELECT B.* FROM
		(SELECT A.*, ROWNUM R FROM
		(SELECT M.*, RO.GRANTNO, RO.GRANTNAME FROM MEMBER M LEFT JOIN MEMBERROLE MR
		ON(M.USERNO=MR.USERNO) LEFT JOIN ROLE RO ON(MR.GRANTNO=RO.GRANTNO)
		<include refid="searchSql"></include>
		 ORDER BY M.USERNO)A)B
		 WHERE R BETWEEN #{startRow} AND #{lastRow}
  	</select>
  	
  	<resultMap id="getResult" type="MemberDTO">
			<id column="USERNO" property="userNo" />
			<result column="userid" property="userId" />
			<result column="userpw" property="userPw" />
			<result column="name" property="name" />
			<result column="email" property="email" />
			<result column="birth" property="birth" />
			<result column="address" property="address" />
			<result column="phone" property="phone" />
			<result column="accountdate" property="accountDate" />
			<result column="intro" property="intro" />
			<result column="statusNo" property="statusNo" />
			<!-- 08/28 추가 -->
			<result column="zipcode" property="zipCode" />
			<result column="refaddress" property="refAddress" />
			<result column="detailaddress" property="detailAddress" />
			<result column="FILENAME" property="fileName" />
	
			<collection property="roles" javaType="List" ofType="RoleDTO">
				<id column="GRANTNO" property="grantNo" />
				<result column="GRANTNAME" property="grantName" />
			</collection>
		</resultMap>
  	
  	<select id="getTotal" parameterType="Pager" resultType="Long">
  		SELECT COUNT(USERNO) FROM MEMBER M
  		<include refid="searchSql"></include>
  	</select>
  	
  	<update id="statusChange" parameterType="MemberDTO">
  		UPDATE MEMBER SET STATUSNO=#{statusNo}
  		WHERE USERNO=#{userNo}
  	</update>
  	
  	<select id="memberDetail" parameterType="MemberDTO" resultMap="getResult">
		SELECT M.*, RO.GRANTNO, RO.GRANTNAME, P.FILENAME
		FROM MEMBER M LEFT JOIN MEMBERROLE MR
		ON(M.USERNO=MR.USERNO)
		LEFT JOIN ROLE RO ON(MR.GRANTNO=RO.GRANTNO)
		LEFT JOIN PROFILE P ON(P.USERNO=M.USERNO)
		WHERE M.USERNO=#{userNo}
  	</select>
  	
  	<update id="memberUpdate" parameterType="MemberDTO">
  		UPDATE MEMBER SET
  		STATUSNO=#{statusNo},
  		USERPW=#{userPw},NAME=#{name},
  		BIRTH=#{birth},EMAIL=#{email},
  		PHONE=#{phone},INTRO=#{intro}
  		WHERE USERNO=#{userNo}
  	</update>
  	
  	<insert id="reportAdd" parameterType="Map">
  		<selectKey keyProperty="report.reportNo" resultType="Long" order="BEFORE">
 			SELECT REPORT_SEQ.NEXTVAL FROM DUAL 
 		</selectKey>
  		INSERT INTO REPORT
  		VALUES (#{report.reportNo}, #{report.userNo}, #{report.catNo}, 0, #{report.title}, #{report.rContents}, #{member.userId}, SYSDATE)
  	</insert>
  	
  	 <insert id="setFileAdd" parameterType="ReportFileDTO">
 		INSERT INTO REPORTIMAGE
 		VALUES (REPORTIMAGE_SEQ.NEXTVAL, #{reportNo}, #{originalName}, #{fileName})
 	</insert>
  	
  	<select id="reportList" parameterType="Pager" resultType="ReportDTO">
  		SELECT B.* FROM
  		(SELECT ROWNUM R, A.* FROM
  		(SELECT RE.*, C.CATNAME FROM REPORT RE JOIN REPORTCATEGORY C
  		ON(RE.CATNO=C.CATNO)ORDER BY RE.REPORTNO DESC)A
  		<include refid="searchSql2"></include>)B
  		WHERE R BETWEEN #{startRow} AND #{lastRow}
  	</select>
  	
  	<select id="reportTotal" parameterType="Pager" resultType="Long">
  		SELECT COUNT(A.REPORTNO) FROM
  		(SELECT RE.*, C.* FROM REPORT RE
  		JOIN REPORTCATEGORY C ON(RE.CATNO=C.CATNO))A
  		<include refid="searchSql2"></include>
  	</select>
  	
  	<update id="reportStatus" parameterType="ReportDTO">
  		UPDATE REPORT SET STATUSNO=1 WHERE REPORTNO=#{reportNo}
  	</update>
  </mapper>